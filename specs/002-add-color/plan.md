# Implementation Plan: Add Color Parameter

**Branch**: `002-add-color` | **Date**: February 18, 2026 | **Spec**: [spec.md](spec.md)  
**Input**: Feature specification from `/specs/002-add-color/spec.md`

**Note**: This plan is generated by `/speckit.plan` command based on clarified requirements.

## Summary

**Primary Goal**: Add a `--color` parameter to the AsciiArt CLI application, allowing users to render ASCII art in terminal colors while maintaining backward compatibility and accessibility.

**Scope**: 
- P1: Core color rendering with 8 standard terminal colors
- P2: Color discovery and validation with helpful error messages  
- P2: Colorblind accessibility and graceful degradation

**Technical Approach**: 
- Extend `CommandLineOptions` to accept `--color` parameter
- Enhance `RenderResult` with optional Color metadata
- Implement platform-aware color code generation (ANSI for Linux/macOS, Windows Console API for Windows)
- Apply colors at console output stage only (clean separation from rendering logic)
- Implement color validation with accessible color checking and suggestions

## Technical Context

**Language/Version**: C# / .NET 6.0  
**Primary Dependencies**: System.Console (built-in), no external color libraries required initially  
**Storage**: N/A (CLI application, no persistence)  
**Testing**: xUnit + FluentAssertions (established in project)  
**Target Platform**: Windows, Linux, macOS (multi-platform CLI)  
**Project Type**: Single console application with modular architecture (CLI → Core → Fonts)  
**Performance Goals**: Output generated in <200ms for standard inputs (per constitution)  
**Constraints**: 
- <200ms startup and output time (constitution requirement)
- 80×24 terminal minimum (constitution requirement)
- Must pass comprehensive test suite (constitution testing standard)
- All public methods require XML doc comments (constitution)
  
**Scale/Scope**: 
- 3 existing C# projects (CLI, Core, Fonts)
- 2 existing test projects (extending)
- Estimated 5-8 new classes/enums, 300-500 lines of production code, 400-600 lines of test code

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Code Quality ✅ **PASS**
- **Requirement**: XML doc comments for all public methods
- **Design**: Will add new public Color enum and helper utilities; all will include XML docs
- **Status**: No violations; plan includes documentation in contracts and quickstart

### II. Testing Standards ✅ **PASS** (NON-NEGOTIABLE)
- **Requirement**: Comprehensive test coverage for features; code must not be complete until tests pass
- **Design**: Will create unit tests for:
  - Color parsing and validation (valid/invalid colors, edge cases)
  - Color code generation for each platform (Windows/ANSI)
  - Colorblind warning and suggestion logic
  - Integration tests for CLI --color parameter
  - Edge cases (multiple parameters, empty values, piped output detection)
- **Status**: No violations; testing is integrated into task design

### III. User Experience Consistency ✅ **PASS**
- **Requirement**: CLI follows consistent pattern (`appname [options] "text"`); clear error messages; 80×24 minimum
- **Design**: 
  - Maintains existing pattern: `asciiart --color red "Hello"`
  - Color parameter follows standard CLI conventions (last wins for duplicates)
  - Error messages list all colors and suggest closest matches
  - Accessibility validation prevents inaccessible color pairs
- **Status**: No violations; feature enhances UX consistency

### IV. Performance Requirements ✅ **PASS**
- **Requirement**: Application startup and output generation <200ms; no redundant recomputation
- **Design**:
  - Color determination happens once during argument parsing
  - Color codes applied at output stage (minimal overhead)
  - No new dependencies; uses built-in System.Console ANSI codes
- **Status**: No violations; performance impact minimal (~1-2ms for color code lookup/application)

**Gate Result**: ✅ **PASS** - Feature aligns with all four constitutional principles.

## Project Structure

### Documentation (this feature)

```text
specs/002-add-color/
├── plan.md              # This file (Phase 1 output)
├── spec.md              # Clarified requirements (completed)
├── research.md          # Phase 0 output (TBD)
├── data-model.md        # Phase 1 output (TBD)
├── quickstart.md        # Phase 1 output (TBD)
├── contracts/           # Phase 1 output (TBD)
│   └── cli.md           # CLI contract with color parameter
└── checklists/
    └── requirements.md  # Requirements quality validation (completed)
```

### Source Code (implementing in existing structure)

```text
src/
├── AsciiArt.Cli/
│   ├── CommandLineOptions.cs      # Extend: Add Color property
│   ├── ConsoleOutput.cs           # Extend: Implement color output logic
│   ├── ColorSupport/              # NEW: Encapsulate color logic
│   │   ├── ColorOption.cs         # NEW: Color enum (8 standard colors)
│   │   ├── ColorValidator.cs      # NEW: Validate colors, check accessibility
│   │   ├── ColorCodeGenerator.cs  # NEW: Generate platform-specific color codes
│   │   └── ColorblindHelper.cs    # NEW: Suggest accessible colors
│   └── Program.cs                 # Extend: Wire up color parameter
│
├── AsciiArt.Core/
│   └── RenderResult.cs            # Extend: Add optional Color metadata property

tests/
├── AsciiArt.Cli.Tests/
│   ├── ColorOptionParsingTests.cs        # NEW: Parse and validate --color
│   ├── ColorOutputGenerationTests.cs     # NEW: Generate correct color codes
│   ├── ColorAccessibilityTests.cs        # NEW: Colorblind warnings/suggestions
│   ├── ColorblindSuggestionTests.cs      # NEW: Finding similar accessible colors
│   └── ApplicationExecutionTests.cs      # Extend: Add color parameter tests
│
└── AsciiArt.Core.Tests/
    └── RenderResultTests.cs              # Extend: Color property tests
```

**Structure Decision**: Extend existing 3-project architecture with a new `ColorSupport` namespace in AsciiArt.Cli. This keeps color logic encapsulated and testable while maintaining clean separation from core rendering. All new code is isolated in the CLI project where it belongs.

## Complexity Tracking

No constitution violations. Feature naturally fits existing architecture.

---

# Phase 0: Research & Clarification Tasks

**Objective**: Resolve technical unknowns before design phase begins

## Research Topics

1. **Windows Console Color API vs ANSI Codes**
   - Decision needed: Use Windows Console API for native colors, or ANSI codes with fallback?
   - Recommendation: ANSI codes work across Windows 10+ with native support; simplifies code
   - Candidate research: `System.Console` ANSI support in .NET 6

2. **Colorblind-Friendly Color Pairs**
   - Decision needed: Which color combinations are distinguishable for common colorblindness types?
   - Recommendation: Protanopia (red-green) and deuteranopia (blue-yellow) safe combinations
   - Candidate research: WCAG color contrast guidelines + accessible color palette standards

3. **Terminal Detection Strategy**
   - Decision needed: How to detect if output is piped/redirected vs interactive terminal?
   - Recommendation: Check `Console.IsOutputRedirected` property in .NET
   - Candidate research: .NET 6 Console APIs for terminal detection

4. **Closest Color Matching Algorithm**
   - Decision needed: How to find "closest" color when user typos a color name?
   - Recommendation: Levenshtein distance or fuzzy string matching
   - Candidate research: Simple string distance calculation vs NuGet fuzzy-match library

---

# Phase 1: Design & Contracts ✅ **COMPLETE**

## Phase 1 Deliverables

✅ **[research.md](research.md)** - Phase 0 Research Complete
- Resolved all 5 technical unknowns
- Decisions made on: ANSI codes, colorblind validation, piped output, typo matching, case-insensitive parsing
- Ready for implementation

✅ **[data-model.md](data-model.md)** - Domain Design Complete  
- ColorOption enum (8 colors)
- RenderResult enhancement (Color? property)
- CommandLineOptions enhancement (Color property)
- ColorCode utility (ANSI codes)
- All validation rules documented

✅ **[contracts/cli.md](contracts/cli.md)** - CLI Contract Complete
- Complete command signature: `asciiart [-c|--color COLORNAME] "text"`
- Parameter specifications with examples
- Output behavior for all scenarios
- Error cases and messages
- Help text format
- Backward compatibility verified

✅ **[quickstart.md](quickstart.md)** - Developer Quickstart Complete
- Architecture overview
- Implementation checklist (P1 & P2)
- Code examples
- Constitution compliance verification
- Related documentation links

✅ **Agent Context Updated**
- Copilot context updated with C#/.NET 6.0, System.Console, no external dependencies
- Ready for implementation assistance

## Phase 1 Summary

**Status**: ✅ **READY FOR IMPLEMENTATION**

**Constitution Check (Re-verified)**:
- ✅ Code Quality: XML comments required
- ✅ Testing Standards: Comprehensive tests required  
- ✅ UX Consistency: Maintains CLI patterns
- ✅ Performance: <2ms overhead, well within budget

**Design Outcomes**:
- 5 new classes in ColorSupport namespace
- 2 properties added to existing classes (RenderResult, CommandLineOptions)
- 4 test files with 15-20 tests per file
- 0 breaking changes; fully backward compatible
- Estimated 12-17 hours implementation + testing

**Next Phase**: `/speckit.tasks` to generate implementation task breakdown
